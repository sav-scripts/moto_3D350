<script type="x-shader/x-vertex" id="vertex">

    uniform vec3 projectedMouse;

    attribute float size;
    attribute vec4 ca;

    varying vec4 vColor;

    void main() {

        vColor = ca;

        vec3 vp = vec3(position);

        //position.z += 1.0;

        vec4 mvPosition = modelViewMatrix * vec4( vp, 1.0 );


        float vSize = size;

        float dist = distance(position.xyz, projectedMouse.xyz);
        float extraSize = smoothstep(10.0, 0.0, dist) * 1.0;
        //vSize = size + extraSize;

        gl_PointSize = 1500.0 * vSize * ( 1.0 / length( mvPosition.xyz ) );

        vp.z += extraSize * 5.0;


        mvPosition = modelViewMatrix * vec4( vp, 1.0 );
        gl_Position = projectionMatrix * mvPosition;

    }

</script>

<script type="x-shader/x-fragment" id="fragment">

    uniform vec3 color;
    uniform sampler2D texture;

    varying vec4 vColor;

    void main() {

        vec4 outColor = texture2D( texture, gl_PointCoord );

        //if ( outColor.a < 0.5 ) discard;

        gl_FragColor = outColor * vec4( color * vColor.xyz, 1.0 );

        //gl_FragColor = outColor;


        float depth = gl_FragCoord.z / gl_FragCoord.w;
        const vec3 fogColor = vec3( 0.0 , .0, .0 );

        float fogFactor = smoothstep( 400.0, 2200.0, depth );

        //float fogFactor = 1.0;
        gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );

    }

</script>